{% extends "base.html" %}
{% load i18n widget_tweaks %}

{% block title %}{% trans "æˆ¿ã®å†™çœŸè¿½åŠ " %}{% endblock %}

{% block content %}
<h1 class="h5 mb-3">{% trans "æˆ¿ã®æˆé•·è¨˜éŒ²å†™çœŸã‚’è¿½åŠ " %}</h1>

<div class="row justify-content-center">
  <div class="col-12 col-md-8 col-lg-6">
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- ğŸ“· ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
      <div class="mb-3">
        <label for="id_image">ã‚¹ãƒãƒ›ã¾ãŸã¯PCã‹ã‚‰ç”»åƒã‚’é¸æŠ</label>
        <input type="file" name="image" id="id_image"
               accept="image/*" capture="environment"
               class="form-control">
        <div class="form-text">ã‚¹ãƒãƒ›ãªã‚‰ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã™ã€‚PCã§ã¯ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
      </div>

      <!-- ğŸ“· Webã‚«ãƒ¡ãƒ©æ’®å½±ç”¨ï¼ˆPCç”¨ï¼‰ -->
      <div class="mt-4">
        <h5>ã¾ãŸã¯ã€PCã®ã‚«ãƒ¡ãƒ©ã§æ’®å½±</h5>
        <video id="camera" autoplay style="width: 100%; max-width: 400px;"></video>
        <canvas id="snapshot" style="display:none;"></canvas>

        <button type="button" id="capture" class="btn btn-outline-primary mt-2">ğŸ“¸ æ’®å½±</button>

        <input type="hidden" name="image_data" id="image_data">
        <img id="preview" src="" style="display:none; margin-top: 10px; max-width: 100%;">
      </div>

      <!-- æ’®å½±æ—¥æ™‚ -->
      <div class="mb-3 mt-4">
        {{ form.taken_at.label_tag }}
        {{ form.taken_at|add_class:"form-control" }}
      </div>

      <!-- ãƒ¡ãƒ¢æ¬„ -->
      <div class="mb-3">
        {{ form.note.label_tag }}
        {{ form.note|add_class:"form-control" }}
      </div>

      <div class="d-flex justify-content-between">
        <button type="submit" class="btn btn-success">{% trans "ä¿å­˜" %}</button>
        <a href="{% url 'cluster_detail' cluster.id %}" class="btn btn-secondary">{% trans "ã‚­ãƒ£ãƒ³ã‚»ãƒ«" %}</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

const video = document.getElementById('camera');
const canvas = document.getElementById('snapshot');
const captureButton = document.getElementById('capture');
const imageDataInput = document.getElementById('image_data');
const preview = document.getElementById('preview');

// ãƒ¢ãƒã‚¤ãƒ«ï¼ˆiPhoneã‚„Androidï¼‰ã§ã¯PCç”¨ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã‚’éè¡¨ç¤ºã«ã™ã‚‹
if (isMobile) {
  video.style.display = "none";
  captureButton.style.display = "none";
} else {
  // PCã§ã¯getUserMediaã§ã‚«ãƒ¡ãƒ©èµ·å‹•
  navigator.mediaDevices.getUserMedia({
    video: { facingMode: { ideal: "environment" } }
  })
  .then((stream) => {
    video.srcObject = stream;
  })
  .catch((err) => {
    alert("ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“ï¼š" + err.message);
  });

  // æ’®å½±å‡¦ç†ï¼ˆPCç”¨ï¼‰
  captureButton.addEventListener('click', () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    const dataURL = canvas.toDataURL('image/png');
    imageDataInput.value = dataURL;
    preview.src = dataURL;
    preview.style.display = 'block';
  });
}
</script>
{% endblock %}
